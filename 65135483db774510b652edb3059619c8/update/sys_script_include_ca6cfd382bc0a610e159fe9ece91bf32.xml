<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
    <sys_script_include action="INSERT_OR_UPDATE">
        <access>public</access>
        <active>true</active>
        <api_name>x_snc_agile.ImportDataFromAttachments</api_name>
        <caller_access/>
        <client_callable>false</client_callable>
        <description>Imports data from an attachment to the given backlog item.</description>
        <name>ImportDataFromAttachments</name>
        <script><![CDATA[function ImportDataFromAttachments(vBacklogItem)
{
	var IsValidRecord = x_snc_devtools.IsValidRecord;
	var ArrayPushUnique = x_snc_devtools.ArrayPushUnique;
	var GetValue = x_snc_devtools.GetValue;
	var RecordInsertOrUpdate = x_snc_devtools.RecordInsertOrUpdate;
	var RecordGetValue = x_snc_devtools.RecordGetValue;
	var GetArrayValue = x_snc_devtools.GetArrayValue;
	var RecordSetValue = x_snc_devtools.RecordSetValue;
	var GetStringValue = x_snc_devtools.GetStringValue;


	var progresstracker = new x_snc_devtools.ProgressTrackerAPI();

	progresstracker.Start();
	progresstracker.SetText('Importing data...');
	progresstracker.SetPercentageProgress(1);

	var result = {};

	var grBacklogItem = GetBacklogItemRecord(vBacklogItem);
	if (IsValidRecord(grBacklogItem) == false)
	{
		progresstracker.SetResult(null,false,'Backlog item not found!');
		LogError('ImportDataFromAttachments: Backlog item not found!');
		return result;
	}

	var grBacklog = GetBacklogRecord(grBacklogItem.backlog);
	if (IsValidRecord(grBacklog) == false)
	{
		progresstracker.SetResult(null,false,'Backlog not found!');
		LogError('ImportDataFromAttachments: Backlog not found!');
		return result;
	}

	var grAttachment = new GlideRecord('sys_attachment');
	grAttachment.addQuery('table_name','=','x_snc_agile_backlog_item'); 
	grAttachment.addQuery('table_sys_id','=', grBacklogItem.sys_id);
	grAttachment.addQuery('file_name','CONTAINS', '.csv');
	grAttachment.query();

	var nFiles = grAttachment.getRowCount();
	if (nFiles == 0)
	{
		progresstracker.SetResult(null,true,'No files to import');
		Log('ImportDataFromAttachments: No files to import!');
		return result;
	}

	var fProgressPerFile = 100 / nFiles;

	var nFile = 0;
	while (grAttachment.next())
	{
		Log('Import from '+grAttachment.file_name+'');

		progresstracker.SetText('Importing from '+grAttachment.file_name);
		progresstracker.SetPercentageProgress(fProgressPerFile * nFile);

		var sysAttachment = new GlideSysAttachment();
		var strCsv = sysAttachment.getContent(grAttachment);

		var aArisData = x_snc_devtools.ParseCsv(strCsv);

		var aSystems = [];
		var aPersonas = [];

		var aLevel1 = [];
		var aLevel2 = [];
		var aLevel3 = [];

		for (var nItem = 0; nItem < aArisData.length; nItem++)
		{
			var arisItem = aArisData[nItem];

			Log('Item '+nItem+':\n'+x_snc_devtools.RenderValue(arisItem));

			var strSystem = GetStringValue(GetValue(arisItem,'System'));
			var strPersona = GetStringValue(GetValue(arisItem,'Persona'));
			var strLevel1 = GetStringValue(GetValue(arisItem,'L1'));
			var strLevel2 = GetStringValue(GetValue(arisItem,'L2'));
			var strLevel3 = GetStringValue(GetValue(arisItem,'L3'));

			strSystem = strSystem.trim();
			strPersona = strPersona.trim();


			var strLevel1Name = strLevel1;
			var strLevel2Name = strLevel1 + ' - ' + strLevel2;
			var strLevel3Name = strLevel1 + ' - ' + strLevel2 + ' - ' + strLevel3;

			aLevel1 = ArrayPushUnique(aLevel1,strLevel1Name);
			aLevel2 = ArrayPushUnique(aLevel2,strLevel2Name);
			aLevel3 = ArrayPushUnique(aLevel3,strLevel3Name);
		

			// Systems
			var strSystemSysId = '';
			if (strSystem != '')
			{
				aSystems = ArrayPushUnique(aSystems,strSystem);

				strSystemSysId = x_snc_devtools.RecordInsertOrUpdate(
					'x_snc_agile_backlog_item',
					{
						short_description: strSystem,
						backlog: grBacklog.sys_id
					},
					{
						description: 'Imported'
					},
					{
						
					});			
			}

			// Personas
			var strPersonaSysId = '';
			if (strPersona != '')
			{			
				aPersonas = ArrayPushUnique(aPersonas,strPersona);

				strPersonaSysId = x_snc_devtools.RecordInsertOrUpdate(
					'x_snc_agile_persona',
					{
						name: strPersona
					},
					{
						description: 'Imported'
					},
					{});
			}

			// Level 3
			var strLevel3SysId = x_snc_devtools.RecordInsertOrUpdate(
				'x_snc_agile_backlog_item',
				{
					short_description: strLevel3,
					backlog: grBacklog.sys_id
				},
				{
					description: 'Imported'
				},
				{
					
				});

			// Add personas to Level 3
			if (strPersonaSysId != '')
			{
				var strPersonas = RecordGetValue(
					'x_snc_agile_backlog_item',strLevel3SysId,
					'personas');
				var aPersonas = GetArrayValue(strPersonas);
				aPersonas = ArrayPushUnique(aPersonas,strPersonaSysId);
				RecordSetValue(
					'x_snc_agile_backlog_item',strLevel3SysId,
					'personas',
					GetStringValue(aPersonas));
			}
			
			// Level 2
			var strLevel2SysId = x_snc_devtools.RecordInsertOrUpdate(
				'x_snc_agile_backlog_item',
				{
					short_description: strLevel2,
					backlog: grBacklog.sys_id
				},
				{
					description: 'Imported'
				},
				{
					
				});

			// Add dependencies to Level 2
			var strRequiredItems = RecordGetValue(
				'x_snc_agile_backlog_item',strLevel2SysId,
				'required_backlog_items');
			var aRequiredItems = GetArrayValue(strRequiredItems);
			aRequiredItems = ArrayPushUnique(aRequiredItems,strLevel3SysId);
			RecordSetValue(
				'x_snc_agile_backlog_item',strLevel2SysId,
				'required_backlog_items',
				GetStringValue(aRequiredItems));

			// Level 1
			var strLevel1SysId = x_snc_devtools.RecordInsertOrUpdate(
				'x_snc_agile_backlog_item',
				{
					short_description: strLevel1,
					backlog: grBacklog.sys_id
				},
				{
					description: 'Imported'
				},
				{
					
				});

			// Add dependencies to Level 1
			var strRequiredItems = RecordGetValue(
				'x_snc_agile_backlog_item',strLevel1SysId,
				'required_backlog_items');
			var aRequiredItems = GetArrayValue(strRequiredItems);
			aRequiredItems = ArrayPushUnique(aRequiredItems,strLevel2SysId);
			RecordSetValue(
				'x_snc_agile_backlog_item',strLevel1SysId,
				'required_backlog_items',
				GetStringValue(aRequiredItems));

			// Add system dependency to Level 3
			if (strSystemSysId != '')
			{
				var strRequiredItems = RecordGetValue(
					'x_snc_agile_backlog_item',strLevel3SysId,
					'required_backlog_items');
				var aRequiredItems = GetArrayValue(strRequiredItems);
				aRequiredItems = ArrayPushUnique(aRequiredItems,strSystemSysId);
				RecordSetValue(
					'x_snc_agile_backlog_item',strLevel3SysId,
					'required_backlog_items',
					GetStringValue(aRequiredItems));				
			}

			// Add dependencies to Reference Item
			var aRequiredItems =
				GetArrayValue(
					RecordGetValue(
						'x_snc_agile_backlog_item',grBacklogItem.sys_id,
						'required_backlog_items'));
			aRequiredItems = ArrayPushUnique(aRequiredItems,strLevel1SysId);
			RecordSetValue(
				'x_snc_agile_backlog_item',grBacklogItem.sys_id,
				'required_backlog_items',
				GetStringValue(aRequiredItems));				

		}
	}
	progresstracker.SetPercentageProgress(100);
	progresstracker.SetText('Import complete.');
	progresstracker.SetResult(null,true,'Import complete');
	
	Log('ImportDataFromAttachments: Import complete');

	return result;
}]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2025-02-28 13:50:03</sys_created_on>
        <sys_id>ca6cfd382bc0a610e159fe9ece91bf32</sys_id>
        <sys_mod_count>14</sys_mod_count>
        <sys_name>ImportDataFromAttachments</sys_name>
        <sys_package display_value="Agile WORK IN PROGRESS" source="x_snc_agile">65135483db774510b652edb3059619c8</sys_package>
        <sys_policy>read</sys_policy>
        <sys_scope display_value="Agile WORK IN PROGRESS">65135483db774510b652edb3059619c8</sys_scope>
        <sys_update_name>sys_script_include_ca6cfd382bc0a610e159fe9ece91bf32</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2025-03-05 13:23:52</sys_updated_on>
    </sys_script_include>
</record_update>
